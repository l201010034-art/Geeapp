<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe Climático de Campeche</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LeafletJS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet Draw Plugin -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <!-- Chart.js for Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        :root {
            --maroon-color: #800000;
            --lighter-maroon: #a04040;
            --header-text-color: #FFFFFF;
            --control-text-color: #000000;
        }
        body { font-family: 'Inter', sans-serif; }
        #map { height: 100vh; }
        .control-panel { background-color: var(--maroon-color); color: var(--header-text-color); }
        .control-section { background-color: var(--lighter-maroon); }
        .control-label { font-weight: bold; color: var(--header-text-color); }
        .custom-btn {
            background-color: var(--lighter-maroon);
            color: var(--control-text-color);
            font-weight: bold;
            border: 1px solid var(--control-text-color);
            transition: background-color 0.3s;
        }
        .custom-btn:hover { background-color: #b05050; }
        .custom-btn-action { background-color: #f0ad4e; color: black; }
        .custom-btn-fire { background-color: #c9302c; color: black; }
        select, input[type="text"] { background-color: var(--lighter-maroon); color: var(--control-text-color); border-color: #502020 }
        #loading-indicator {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.7); color: white; padding: 20px 40px;
            border-radius: 10px; z-index: 2000; display: none;
            font-size: 1.2em; text-align: center;
        }
    </style>
</head>
<body class="bg-gray-900">

    <div id="loading-indicator">Cargando...</div>

    <div class="flex flex-col md:flex-row">
        <!-- Control Panel -->
        <div class="control-panel w-full md:w-[400px] h-screen overflow-y-auto p-4 space-y-3">
            <h1 class="text-2xl font-bold text-center">Informe Climático de Campeche</h1>

            <!-- Date Range -->
            <div>
                <label class="control-label">1. Rango de Fechas</label>
                <div class="grid grid-cols-2 gap-2 mt-1">
                    <input type="text" id="startDate" value="2023-01-01" class="w-full p-2 rounded">
                    <input type="text" id="endDate" value="2023-12-31" class="w-full p-2 rounded">
                </div>
            </div>

            <!-- Zones -->
            <div>
                <label class="control-label">2. Zona de Interés</label>
                <div id="zonaSelectorPanel" class="control-section p-2 rounded mt-1">
                    <!-- Checkboxes will be inserted here by JS -->
                </div>
                 <p class="text-xs text-gray-300 mt-1">O dibuja un área en el mapa. El área dibujada tendrá prioridad.</p>
            </div>

            <!-- Variable -->
            <div>
                <label class="control-label">3. Variable Climática</label>
                <select id="variableSelector" class="w-full p-2 rounded mt-1">
                    <!-- Options inserted by JS -->
                </select>
            </div>
            
            <!-- Specific Analysis Panels -->
            <div id="precipAnalysisPanel" class="hidden space-y-2 p-2 border border-yellow-400 rounded">
                 <label class="control-label text-yellow-300">Análisis Específico de Precipitación</label>
                 <select id="precipAnalysisSelector" class="w-full p-2 rounded">
                     <option value="accumulated">Acumulado</option>
                     <option value="intensity">Intensidad de Lluvia</option>
                     <option value="frequency">Frecuencia de Lluvias Fuertes (>20mm)</option>
                 </select>
                 <select id="precipAggregationSelector" class="w-full p-2 rounded">
                     <option value="day">Agregación Diaria</option>
                     <option value="week">Agregación Semanal</option>
                     <option value="month">Agregación Mensual</option>
                     <option value="year">Agregación Anual</option>
                 </select>
                 <button id="precipAnalysisButton" class="w-full p-2 rounded custom-btn custom-btn-action">Ejecutar Análisis de Precipitación</button>
            </div>
            
            <div id="tempAnalysisPanel" class="hidden space-y-2 p-2 border border-yellow-400 rounded">
                <label class="control-label text-yellow-300">Análisis de Temperatura Extrema</label>
                <select id="tempAnalysisSelector" class="w-full p-2 rounded">
                    <option value="heatwave">Análisis de Olas de Calor</option>
                    <option value="frost">Análisis de Heladas</option>
                </select>
                <button id="tempAnalysisButton" class="w-full p-2 rounded custom-btn custom-btn-action">Ejecutar Análisis de Temperatura</button>
            </div>

            <!-- Chart Type -->
            <div>
                <label class="control-label">4. Tipo de Gráfico (variables generales)</label>
                <select id="chartTypeSelector" class="w-full p-2 rounded mt-1">
                    <option value="line">Línea</option>
                    <option value="bar">Barras</option>
                    <option value="scatter">Dispersión</option>
                </select>
            </div>

            <!-- Actions -->
            <div>
                 <label class="control-label">5. Acciones Generales</label>
                 <div class="grid grid-cols-2 gap-2 mt-1">
                    <button id="loadDataButton" class="p-2 rounded custom-btn">Cargar Datos</button>
                    <button id="compareButton" class="p-2 rounded custom-btn">📊 Comparar</button>
                 </div>
            </div>

            <!-- Specific Products -->
            <div>
                <label class="control-label">6. Productos Específicos</label>
                <div class="space-y-2 mt-1">
                    <select id="spiTimescaleSelector" class="w-full p-2 rounded">
                        <option value="3">SPI 3 Meses (sequía a corto plazo)</option>
                        <option value="6">SPI 6 Meses (sequía estacional)</option>
                        <option value="12">SPI 12 Meses (sequía a largo plazo)</option>
                    </select>
                    <button id="calculateSpiButton" class="w-full p-2 rounded custom-btn custom-btn-action">Calcular SPI</button>
                    <button id="fireRiskButton" class="w-full p-2 rounded custom-btn custom-btn-fire">🔥 Riesgo de Incendio</button>
                </div>
            </div>
            
            <!-- Tools -->
             <div>
                <label class="control-label">7. Herramientas</label>
                 <div class="grid grid-cols-2 gap-2 mt-1">
                    <button id="clearDrawingButton" class="p-2 rounded custom-btn">Limpiar Dibujo</button>
                    <button id="resetButton" class="p-2 rounded custom-btn">Reiniciar App</button>
                 </div>
            </div>

            <!-- Status -->
            <div>
                <label class="control-label">Resumen Estadístico</label>
                <div id="weatherStatusLabel" class="control-section p-2 rounded mt-1 text-sm h-24 whitespace-pre-wrap">Selecciona opciones y carga datos.</div>
            </div>

            <!-- Chart -->
            <div>
                <label class="control-label">Gráfico de Serie Temporal</label>
                <div class="control-section p-2 rounded mt-1 bg-white">
                    <canvas id="timeSeriesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Map Panel -->
        <div id="map" class="w-full h-[50vh] md:h-screen"></div>
    </div>

<script>
// =========================================================================================
// === CONFIGURACIÓN Y ESTADO DE LA APLICACIÓN
// =========================================================================================
const campecheGeom = { "type": "Polygon", "coordinates": [[[-92.4,17.8],[-89.1,17.8],[-89.1,20.8],[-92.4,20.8],[-92.4,17.8]]] };
const zonas = {
    'Todo el Estado': { geom: { "type": "Polygon", "coordinates": [[[-92.44, 17.81], [-89.1, 17.81], [-89.1, 20.85], [-92.44, 20.85], [-92.44, 17.81]]] }, style: {color: 'white', fillColor: '#FFFFFF', fillOpacity: 0.1} },
    'Zona 1, Ciudad Campeche': { geom: {"type":"Polygon","coordinates":[[[-90.4531,19.8993],[-90.489,19.8781],[-90.5211,19.8612],[-90.529,19.8671],[-90.5343,19.8631],[-90.5273,19.8578],[-90.5366,19.8549],[-90.5444,19.8461],[-90.5529,19.8386],[-90.5613,19.8334],[-90.5685,19.8282],[-90.5702,19.8273],[-90.5712,19.8277],[-90.5735,19.8269],[-90.5734,19.8253],[-90.5792,19.8218],[-90.5852,19.8187],[-90.59,19.8153],[-90.5929,19.8183],[-90.5997,19.8136],[-90.601,19.8085],[-90.6102,19.8018],[-90.6165,19.7991],[-90.6195,19.7967],[-90.6261,19.7939],[-90.6294,19.7909],[-90.6327,19.79],[-90.6333,19.7847],[-90.6389,19.779],[-90.639,19.7746],[-90.6349,19.7724],[-90.6277,19.778],[-90.6159,19.7809],[-90.5992,19.7835],[-90.5922,19.7947],[-90.5496,19.7942],[-90.5422,19.7914],[-90.5308,19.7932],[-90.5232,19.7891],[-90.5167,19.7923],[-90.5048,19.79],[-90.5055,19.7809],[-90.5039,19.7776],[-90.508,19.7714],[-90.5115,19.7638],[-90.5099,19.7598],[-90.5171,19.7573],[-90.5272,19.7512],[-90.5223,19.7435],[-90.5138,19.7338],[-90.4989,19.7403],[-90.4857,19.7552],[-90.4698,19.7498],[-90.4596,19.7476],[-90.4611,19.7558],[-90.4641,19.7628],[-90.475,19.7666],[-90.482,19.7835],[-90.4643,19.796],[-90.4585,19.8226],[-90.4556,19.8433],[-90.446,19.8818],[-90.4531,19.8993]]]}, style: {color: 'blue', fillColor: '#0000FF', fillOpacity: 0.1} },
    'Zona 2, Lerma': { geom: {"type":"Polygon","coordinates":[[[-90.592,19.8193],[-90.5996,19.8133],[-90.6083,19.8036],[-90.6327,19.7897],[-90.6385,19.7802],[-90.6396,19.7744],[-90.6351,19.7716],[-90.6279,19.7779],[-90.5997,19.7824],[-90.5924,19.7946],[-90.5741,19.7954],[-90.5831,19.8203],[-90.592,19.8193]]]}, style: {color: 'green', fillColor: '#00FF00', fillOpacity: 0.1} },
    'Zona 3, Chiná': { geom: {"type":"Polygon","coordinates":[[[-90.5045,19.7762],[-90.5187,19.7562],[-90.5211,19.742],[-90.5021,19.7384],[-90.4856,19.7542],[-90.4626,19.7483],[-90.4602,19.7518],[-90.4748,19.7647],[-90.4813,19.7833],[-90.5046,19.7901],[-90.5045,19.7762]]]}, style: {color: 'orange', fillColor: '#FFA500', fillOpacity: 0.1} },
    'Zona 4, San Fco. Campeche': { geom: {"type":"Polygon","coordinates":[[[-90.5051,19.7895],[-90.4811,19.7838],[-90.4643,19.7964],[-90.4464,19.8814],[-90.4541,19.899],[-90.521,19.8621],[-90.5292,19.8663],[-90.5346,19.8625],[-90.5332,19.8567],[-90.5831,19.8203],[-90.5722,19.794],[-90.5495,19.7938],[-90.5261,19.7906],[-90.5051,19.7895]]]}, style: {color: 'purple', fillColor: '#800080', fillOpacity: 0.1} }
};
const varParams = {
  'Temperatura del Aire (°C)': { id: 'TAM', unit: '°C' },
  'Humedad Relativa (%)': { id: 'HR', unit: '%' },
  'Radiación Solar (W/m²)': { id: 'Radiacion_Solar', unit: 'W/m²' },
  'Velocidad del Viento (m/s)': { id: 'wind_speed', unit: 'm/s' },
  'Temp. Superficial (LST °C)': { id: 'LST', unit: '°C' },
  'Precipitación Acumulada (mm)': { id: 'Precipitacion', unit: 'mm' },
  'Evapotranspiración (mm/8 días)': { id: 'ET', unit: 'mm/8d' },
  'Evapotranspiración Potencial (mm/8 días)': { id: 'PET', unit: 'mm/8d' },
  'Días Grado de Crecimiento (°C día)': { id: 'GDD', unit: '°C día' }
};

let map;
let drawnItems;
let timeSeriesChart;
let currentMapLayer = null;
let zoneLayers = {};

// =========================================================================================
// === INICIALIZACIÓN
// =========================================================================================
document.addEventListener('DOMContentLoaded', () => {
    initMap();
    populateSelectors();
    initChart();
    attachEventListeners();
    // Activate the first zone by default
    document.querySelector('#zonaSelectorPanel input[type="checkbox"]').click();
});

function initMap() {
    map = L.map('map').setView([19.83, -90.53], 9);
    L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map);

    drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: {
            polygon: true,
            polyline: false,
            rectangle: true,
            circle: false,
            marker: false,
            circlemarker: false
        }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, (e) => {
        drawnItems.clearLayers();
        const layer = e.layer;
        drawnItems.addLayer(layer);
        clearZoneCheckboxes();
    });
     map.on(L.Draw.Event.EDITED, () => clearZoneCheckboxes());
}

function populateSelectors() {
    const varSelector = document.getElementById('variableSelector');
    Object.keys(varParams).forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        varSelector.appendChild(option);
    });

    const zonaPanel = document.getElementById('zonaSelectorPanel');
    Object.keys(zonas).forEach(name => {
        const div = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `check-${name}`;
        checkbox.value = name;
        checkbox.className = 'mr-2';
        checkbox.addEventListener('change', handleZoneCheckboxChange);
        
        const label = document.createElement('label');
        label.htmlFor = `check-${name}`;
        label.textContent = name;
        
        div.appendChild(checkbox);
        div.appendChild(label);
        zonaPanel.appendChild(div);
    });
}

function initChart() {
    const ctx = document.getElementById('timeSeriesChart').getContext('2d');
    timeSeriesChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: []
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'month' },
                    title: { display: true, text: 'Fecha' }
                },
                y: {
                    title: { display: true, text: 'Valor' }
                }
            },
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Serie Temporal' }
            }
        }
    });
}

function attachEventListeners() {
    document.getElementById('loadDataButton').addEventListener('click', handleLoadData);
    document.getElementById('compareButton').addEventListener('click', handleCompareZones);
    document.getElementById('precipAnalysisButton').addEventListener('click', handlePrecipitationAnalysis);
    document.getElementById('tempAnalysisButton').addEventListener('click', handleTemperatureAnalysis);
    document.getElementById('calculateSpiButton').addEventListener('click', handleSpiAnalysis);
    document.getElementById('fireRiskButton').addEventListener('click', handleFireRiskAnalysis);
    document.getElementById('clearDrawingButton').addEventListener('click', clearDrawing);
    document.getElementById('resetButton').addEventListener('click', resetApp);
    document.getElementById('variableSelector').addEventListener('change', toggleAnalysisPanels);
}


// =========================================================================================
// === LÓGICA DE LA INTERFAZ
// =========================================================================================
function setLoading(isLoading, message = 'Cargando...') {
    const indicator = document.getElementById('loading-indicator');
    indicator.textContent = message;
    indicator.style.display = isLoading ? 'block' : 'none';
}

function updateStatus(text) {
    document.getElementById('weatherStatusLabel').textContent = text;
}

function handleZoneCheckboxChange(e) {
    const zoneName = e.target.value;
    const isChecked = e.target.checked;
    
    // Uncheck other boxes
    if (isChecked) {
        document.querySelectorAll('#zonaSelectorPanel input[type="checkbox"]').forEach(cb => {
            if (cb.value !== zoneName) cb.checked = false;
        });
        Object.values(zoneLayers).forEach(layer => map.removeLayer(layer));
        zoneLayers = {};
    }
    
    drawnItems.clearLayers();
    
    if (isChecked) {
        const zona = zonas[zoneName];
        const layer = L.geoJSON(zona.geom, { style: zona.style }).addTo(map);
        zoneLayers[zoneName] = layer;
        map.fitBounds(layer.getBounds());
    } else {
        if (zoneLayers[zoneName]) {
            map.removeLayer(zoneLayers[zoneName]);
            delete zoneLayers[zoneName];
        }
    }
}

function clearZoneCheckboxes() {
    document.querySelectorAll('#zonaSelectorPanel input[type="checkbox"]').forEach(cb => {
        if (cb.checked) {
            cb.checked = false;
            if(zoneLayers[cb.value]) {
                map.removeLayer(zoneLayers[cb.value]);
                delete zoneLayers[cb.value];
            }
        }
    });
}

function clearDrawing() {
    drawnItems.clearLayers();
    // Default to the first zone if no zone is selected
    const anyChecked = Array.from(document.querySelectorAll('#zonaSelectorPanel input[type="checkbox"]')).some(cb => cb.checked);
    if (!anyChecked) {
        document.querySelector('#zonaSelectorPanel input[type="checkbox"]').click();
    }
}

function toggleAnalysisPanels() {
    const selectedVar = document.getElementById('variableSelector').value;
    document.getElementById('precipAnalysisPanel').style.display = (selectedVar === 'Precipitación Acumulada (mm)') ? 'block' : 'none';
    document.getElementById('tempAnalysisPanel').style.display = (selectedVar === 'Temperatura del Aire (°C)') ? 'block' : 'none';
}

function getActiveROIs() {
    // Priority to drawn items
    if (drawnItems.getLayers().length > 0) {
        return drawnItems.getLayers().map((layer, index) => ({
            name: `Área Dibujada ${index + 1}`,
            geom: layer.toGeoJSON().geometry
        }));
    }
    
    // Fallback to selected zones
    const selectedZones = Array.from(document.querySelectorAll('#zonaSelectorPanel input:checked')).map(cb => cb.value);
    if (selectedZones.length > 0) {
        return selectedZones.map(name => ({ name: name, geom: zonas[name].geom }));
    }
    
    return [];
}

function resetApp() {
    clearDrawing();
    clearMapLayers();
    updateStatus('Selecciona opciones y carga datos.');
    timeSeriesChart.data.datasets = [];
    timeSeriesChart.options.plugins.title.text = 'Serie Temporal';
    timeSeriesChart.update();
    
    document.querySelectorAll('#zonaSelectorPanel input:checked').forEach(cb => cb.checked = false);
    Object.values(zoneLayers).forEach(layer => map.removeLayer(layer));
    zoneLayers = {};
    
    document.querySelector('#zonaSelectorPanel input[type="checkbox"]').click();
}

function clearMapLayers() {
    if (currentMapLayer) {
        map.removeLayer(currentMapLayer);
        currentMapLayer = null;
    }
}

// =========================================================================================
// === LÓGICA DE DATOS Y GRÁFICOS
// =========================================================================================

async function callGeeApi(action, params) {
    try {
        setLoading(true, params.loadingMessage || 'Procesando en Google Earth Engine...');
        const response = await fetch('/api/gee', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, ...params })
        });
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Error en el servidor GEE.');
        }
        return await response.json();
    } catch (error) {
        console.error('API Call Error:', error);
        updateStatus(`Error: ${error.message}`);
        return null;
    } finally {
        setLoading(false);
    }
}

function displayMapLayer(tileUrl) {
    clearMapLayers();
    if (tileUrl) {
        currentMapLayer = L.tileLayer(tileUrl, { opacity: 0.7 }).addTo(map);
    }
}

function updateChart(chartData, title, yAxisLabel) {
    timeSeriesChart.data.datasets = chartData.datasets;
    timeSeriesChart.options.plugins.title.text = title;
    timeSeriesChart.options.scales.y.title.text = yAxisLabel;
    
    const chartType = document.getElementById('chartTypeSelector').value;
    timeSeriesChart.config.type = (chartType === 'scatter' || chartType === 'bar') ? chartType : 'line';
    
    timeSeriesChart.update();
}

// =========================================================================================
// === MANEJADORES DE EVENTOS (HANDLERS)
// =========================================================================================

async function handleLoadData() {
    const activeROIs = getActiveROIs();
    if (activeROIs.length === 0) {
        updateStatus('Error: Selecciona una zona o dibuja un área.');
        return;
    }
    const roi = activeROIs[0];
    const varName = document.getElementById('variableSelector').value;
    const params = {
        variable: varParams[varName].id,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        region: roi.geom,
        loadingMessage: 'Cargando datos generales...'
    };
    
    const data = await callGeeApi('getGeneralData', params);
    if (!data) return;

    displayMapLayer(data.tileUrl);
    updateChart({
        datasets: [{
            label: `${varName} en ${roi.name}`,
            data: data.chartData,
            borderColor: '#f0ad4e',
            tension: 0.1
        }]
    }, `Serie temporal para: ${roi.name}`, `${varName}`);
    
    updateStatus(`Estadísticas para ${roi.name} (promedio en el tiempo):\n` +
                 `Promedio: ${data.stats.mean.toFixed(2)} ${varParams[varName].unit}\n` +
                 `Mínimo: ${data.stats.min.toFixed(2)} ${varParams[varName].unit}\n` +
                 `Máximo: ${data.stats.max.toFixed(2)} ${varParams[varName].unit}`);
}

async function handleCompareZones() {
    const activeROIs = getActiveROIs();
    if (activeROIs.length < 2) {
        updateStatus('Error: Selecciona 2+ zonas o dibuja 2+ áreas para comparar.');
        return;
    }
    const varName = document.getElementById('variableSelector').value;
    const params = {
        variable: varParams[varName].id,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        regions: activeROIs,
        loadingMessage: 'Comparando zonas...'
    };
    
    const data = await callGeeApi('getComparisonData', params);
    if (!data) return;

    clearMapLayers();
    const colors = ['#00FFFF', '#00FF00', '#FFFF00', '#FF00FF', '#FF6347', '#DA70D6'];
    const datasets = data.chartData.map((series, index) => ({
        label: series.name,
        data: series.data,
        borderColor: colors[index % colors.length],
        tension: 0.1,
        fill: false
    }));

    updateChart({ datasets }, `Comparación: ${varName}`, `${varName}`);
    updateStatus(`Gráfico de comparación generado para ${activeROIs.length} zonas.`);
}

async function handlePrecipitationAnalysis() {
    const activeROIs = getActiveROIs();
    if (activeROIs.length === 0) { return; }
    const roi = activeROIs[0];

    const params = {
        analysisType: document.getElementById('precipAnalysisSelector').value,
        aggregation: document.getElementById('precipAggregationSelector').value,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        region: roi.geom,
        loadingMessage: 'Analizando precipitación...'
    };

    const data = await callGeeApi('getPrecipitationAnalysis', params);
    if (!data) return;

    displayMapLayer(data.tileUrl);
    timeSeriesChart.config.type = 'bar';
    updateChart({
        datasets: [{
            label: `${data.title} en ${roi.name}`,
            data: data.chartData,
            backgroundColor: '#41b6c4'
        }]
    }, `${data.title} (${params.aggregation}) para ${roi.name}`, data.unit);
    updateStatus(`Valor promedio para ${roi.name}:\n${data.stats.mean.toFixed(2)} ${data.unit}`);
}

async function handleTemperatureAnalysis() {
    const activeROIs = getActiveROIs();
    if (activeROIs.length === 0) { return; }
    const roi = activeROIs[0];

    const params = {
        analysisType: document.getElementById('tempAnalysisSelector').value,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        region: roi.geom,
        loadingMessage: 'Analizando temperatura...'
    };

    const data = await callGeeApi('getTemperatureAnalysis', params);
    if (!data) return;
    
    displayMapLayer(data.tileUrl);
    timeSeriesChart.data.datasets = [];
    timeSeriesChart.update();
    updateStatus(`Resultado para ${roi.name} (${data.title}):\n` +
                 `Valor promedio: ${data.stats.mean.toFixed(2)} ${data.unit}`);
}

async function handleSpiAnalysis() {
    const activeROIs = getActiveROIs();
    if (activeROIs.length === 0) { return; }
    const roi = activeROIs[0];

    const params = {
        timescale: parseInt(document.getElementById('spiTimescaleSelector').value, 10),
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        region: roi.geom,
        loadingMessage: 'Calculando SPI...'
    };
    
    const data = await callGeeApi('getSpiAnalysis', params);
    if (!data) return;

    displayMapLayer(data.tileUrl);
    
    // Custom SPI chart with colors
    const chartData = data.chartData;
    const spiColors = chartData.map(d => {
        const spi = d.y;
        if (spi <= -2.0) return '#d73027';
        if (spi <= -1.5) return '#f46d43';
        if (spi <= -1.0) return '#fdae61';
        if (spi >= 2.0) return '#4575b4';
        if (spi >= 1.5) return '#74add1';
        if (spi >= 1.0) return '#abd9e9';
        return '#cccccc';
    });

    timeSeriesChart.config.type = 'bar';
    updateChart({
        datasets: [{
            label: `SPI ${params.timescale}-Meses en ${roi.name}`,
            data: chartData,
            backgroundColor: spiColors,
            borderColor: spiColors
        }]
    }, `SPI de ${params.timescale} Meses para ${roi.name}`, 'Valor SPI');
    updateStatus(`Análisis SPI completado. Mostrando mapa para la fecha más reciente.`);
}

async function handleFireRiskAnalysis() {
    const activeROIs = getActiveROIs();
    if (activeROIs.length === 0) { return; }
    const roi = activeROIs[0];

    const params = {
        endDate: document.getElementById('endDate').value,
        region: roi.geom,
        loadingMessage: 'Generando mapa de riesgo de incendio...'
    };
    
    const data = await callGeeApi('getFireRiskAnalysis', params);
    if (!data) return;

    displayMapLayer(data.tileUrl);
    timeSeriesChart.data.datasets = [];
    timeSeriesChart.update();
    updateStatus('Mapa de Riesgo de Incendio generado.\n' +
                 'Riesgo calculado usando LST y SPI de 3 meses para la fecha más reciente.');
}

</script>
</body>
</html>
