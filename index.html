<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe Climático de Campeche</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root {
            --maroon-color: #800000;
            --lighter-maroon: #a04040;
            --header-text: #FFFFFF;
            --control-text: #000000;
            --accent-color: #f0ad4e;
            --danger-color: #c9302c;
        }
        body { font-family: 'Inter', sans-serif; }
        .loader { border-top-color: var(--accent-color); }
        .leaflet-draw-toolbar a { background-color: var(--lighter-maroon) !important; color: white !important; }
        .leaflet-draw-section .leaflet-draw-toolbar a { background-image: url('https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/images/spritesheet.png'); background-size: 270px 30px !important; }
        .leaflet-retina .leaflet-draw-section .leaflet-draw-toolbar a { background-image: url('https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/images/spritesheet-2x.png'); background-size: 270px 30px !important; }
        .custom-file-input::-webkit-file-upload-button { visibility: hidden; }
        .custom-file-input::before { content: 'Cargar GeoJSON'; display: inline-block; background: var(--lighter-maroon); color: white; border: 1px solid var(--control-text); padding: 6px 12px; outline: none; white-space: nowrap; cursor: pointer; font-weight: bold; border-radius: 5px; }
    </style>
</head>
<body class="bg-gray-800 text-white flex flex-col md:flex-row h-screen overflow-hidden">

    <!-- Panel de Control -->
    <div id="control-panel" class="w-full md:w-96 bg-[var(--maroon-color)] p-4 overflow-y-auto space-y-4">
        <h1 class="text-xl font-bold text-center text-[var(--header-text)]">Informe Climático de Campeche</h1>

        <!-- 1. Rango de Fechas -->
        <div>
            <label class="text-lg font-semibold text-[var(--header-text)]">1. Rango de Fechas</label>
            <div class="grid grid-cols-2 gap-2 mt-1">
                <input type="date" id="start-date" value="2023-01-01" class="p-2 rounded bg-[var(--lighter-maroon)] text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)]">
                <input type="date" id="end-date" value="2023-12-31" class="p-2 rounded bg-[var(--lighter-maroon)] text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)]">
            </div>
        </div>
        
        <!-- 2. Zona de Interés -->
        <div>
            <label class="text-lg font-semibold text-[var(--header-text)]">2. Zona de Interés</label>
            <div id="zone-selector" class="p-2 mt-1 rounded bg-[var(--lighter-maroon)] text-white space-y-1">
                <!-- Checkboxes de zonas se insertan aquí -->
            </div>
            <p class="text-xs text-gray-300 mt-1">O dibuja en el mapa con las herramientas de la izquierda.</p>
             <input type="file" id="geojson-upload" class="custom-file-input mt-2 text-sm" accept=".geojson,.json">
        </div>

        <!-- 3. Variable Climática -->
        <div>
            <label for="variable-selector" class="text-lg font-semibold text-[var(--header-text)]">3. Variable Climática</label>
            <select id="variable-selector" class="w-full p-2 mt-1 rounded bg-[var(--lighter-maroon)] text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)]">
                <!-- Opciones de variables se insertan aquí -->
            </select>
        </div>

        <!-- Paneles de Análisis Específicos (ocultos por defecto) -->
        <div id="precip-analysis-panel" class="hidden space-y-2 p-2 border border-[var(--accent-color)] rounded">
            <h3 class="font-bold text-[var(--header-text)]">Análisis Específico de Precipitación</h3>
            <select id="precip-analysis-selector" class="w-full p-2 rounded bg-[var(--lighter-maroon)] text-white">
                <option value="accumulated">Acumulado</option>
                <option value="intensity">Intensidad de Lluvia</option>
                <option value="frequency">Frecuencia de Lluvias Fuertes (>20mm)</option>
            </select>
            <select id="precip-aggregation-selector" class="w-full p-2 rounded bg-[var(--lighter-maroon)] text-white">
                <option value="day">Agregación Diaria</option>
                <option value="week">Agregación Semanal</option>
                <option value="month">Agregación Mensual</option>
                <option value="year">Agregación Anual</option>
            </select>
            <button id="run-precip-analysis" class="w-full p-2 font-bold rounded bg-[var(--accent-color)] text-[var(--control-text)] hover:bg-yellow-600 transition-colors">Ejecutar Análisis de Precipitación</button>
        </div>
        <div id="temp-analysis-panel" class="hidden space-y-2 p-2 border border-[var(--accent-color)] rounded">
            <h3 class="font-bold text-[var(--header-text)]">Análisis de Temperatura Extrema</h3>
            <select id="temp-analysis-selector" class="w-full p-2 rounded bg-[var(--lighter-maroon)] text-white">
                <option value="heatwave">Análisis de Olas de Calor</option>
                <option value="frost">Análisis de Heladas</option>
            </select>
            <button id="run-temp-analysis" class="w-full p-2 font-bold rounded bg-[var(--accent-color)] text-[var(--control-text)] hover:bg-yellow-600 transition-colors">Ejecutar Análisis de Temperatura</button>
        </div>
        
        <!-- 4. Tipo de Gráfico -->
        <div>
            <label for="chart-type-selector" class="text-lg font-semibold text-[var(--header-text)]">4. Tipo de Gráfico</label>
            <select id="chart-type-selector" class="w-full p-2 mt-1 rounded bg-[var(--lighter-maroon)] text-white">
                <option>LineChart</option>
                <option>ColumnChart</option>
                <option>ScatterChart</option>
                <option>AreaChart</option>
            </select>
        </div>

        <!-- 5. Acciones Generales -->
        <div>
            <label class="text-lg font-semibold text-[var(--header-text)]">5. Acciones Generales</label>
            <div class="grid grid-cols-2 gap-2 mt-1">
                <button id="load-data-btn" class="p-2 font-bold rounded bg-[var(--lighter-maroon)] border border-[var(--control-text)] hover:bg-opacity-80 transition-colors">Cargar Datos</button>
                <button id="compare-btn" class="p-2 font-bold rounded bg-[var(--lighter-maroon)] border border-[var(--control-text)] hover:bg-opacity-80 transition-colors">📊 Comparar</button>
            </div>
        </div>
        
        <!-- 6. Productos Específicos -->
        <div>
            <label class="text-lg font-semibold text-[var(--header-text)]">6. Productos Específicos</label>
             <div class="space-y-2 mt-1">
                <select id="spi-timescale-selector" class="w-full p-2 rounded bg-[var(--lighter-maroon)] text-white">
                    <option value="3">SPI 3 Meses (sequía a corto plazo)</option>
                    <option value="6">SPI 6 Meses (sequía estacional)</option>
                    <option value="12">SPI 12 Meses (sequía a largo plazo)</option>
                </select>
                <button id="calculate-spi-btn" class="w-full p-2 font-bold rounded bg-[var(--accent-color)] text-[var(--control-text)] hover:bg-yellow-600 transition-colors">Calcular SPI</button>
                <button id="fire-risk-btn" class="w-full p-2 font-bold rounded bg-[var(--danger-color)] text-black hover:bg-red-800 transition-colors">🔥 Riesgo de Incendio</button>
            </div>
        </div>

        <!-- 7. Herramientas -->
        <div>
            <label class="text-lg font-semibold text-[var(--header-text)]">7. Herramientas</label>
            <div class="grid grid-cols-2 gap-2 mt-1">
                <button id="clear-drawing-btn" class="p-2 font-bold rounded bg-[var(--lighter-maroon)] border border-[var(--control-text)] hover:bg-opacity-80 transition-colors">Limpiar Dibujo</button>
                <button id="reset-app-btn" class="p-2 font-bold rounded bg-[var(--lighter-maroon)] border border-[var(--control-text)] hover:bg-opacity-80 transition-colors">Reiniciar App</button>
            </div>
        </div>
        
        <!-- Indicador de Carga y Resumen -->
        <div class="space-y-2 pt-4">
             <div id="loading-indicator" class="hidden items-center gap-2 text-white">
                <div class="loader animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                <span id="loading-message">Procesando...</span>
            </div>
            <div id="stats-summary" class="p-3 rounded bg-[var(--lighter-maroon)] text-white whitespace-pre-wrap text-sm">
                Selecciona opciones y carga datos para ver un resumen.
            </div>
        </div>

    </div>

    <!-- Contenedor del Mapa y Gráfico -->
    <div class="flex-1 flex flex-col h-full">
        <div id="map" class="flex-1 h-1/2 md:h-full"></div>
         <div class="w-full h-1/2 md:h-[40%] bg-gray-900 p-2 overflow-hidden flex flex-col">
            <h2 class="text-lg font-bold text-center text-[var(--header-text)] mb-2">Gráfico de Serie Temporal</h2>
            <div id="chart-container" class="flex-1 min-h-0"></div>
        </div>
    </div>
    
    <script type="module">
        // =========================================================================================
        // === CONFIGURACIÓN INICIAL (Zonas, Variables, Mapa) =======================================
        // =========================================================================================
        const zonas = {
            'Todo el Estado': { geom: {"type":"Polygon","coordinates":[[[-92.44,17.81],[-89.1,17.81],[-89.1,20.85],[-92.44,20.85],[-92.44,17.81]]]}, style: {color: 'white', fillColor: 'FFFFFF22', weight: 2} },
            'Zona 1, Cd. Campeche': { geom: {"type":"Polygon","coordinates":[[[-90.4531,19.8993],[-90.489,19.8781],[-90.5211,19.8612],[-90.529,19.8671],[-90.5343,19.8631],[-90.5273,19.8578],[-90.5366,19.8549],[-90.5444,19.8461],[-90.5529,19.8386],[-90.5613,19.8334],[-90.5685,19.8282],[-90.5702,19.8273],[-90.5712,19.8277],[-90.5735,19.8269],[-90.5734,19.8253],[-90.5792,19.8218],[-90.5852,19.8187],[-90.59,19.8153],[-90.5929,19.8183],[-90.5997,19.8136],[-90.601,19.8085],[-90.6102,19.8018],[-90.6165,19.7991],[-90.6195,19.7967],[-90.6261,19.7939],[-90.6294,19.7909],[-90.6327,19.79],[-90.6333,19.7847],[-90.6389,19.779],[-90.639,19.7746],[-90.6349,19.7724],[-90.6277,19.778],[-90.6159,19.7809],[-90.5992,19.7835],[-90.5922,19.7947],[-90.5496,19.7942],[-90.5422,19.7914],[-90.5308,19.7932],[-90.5232,19.7891],[-90.5167,19.7923],[-90.5048,19.79],[-90.5055,19.7809],[-90.5039,19.7776],[-90.508,19.7714],[-90.5115,19.7638],[-90.5099,19.7598],[-90.5171,19.7573],[-90.5272,19.7512],[-90.5223,19.7435],[-90.5138,19.7338],[-90.4989,19.7403],[-90.4857,19.7552],[-90.4698,19.7498],[-90.4596,19.7476],[-90.4611,19.7558],[-90.4641,19.7628],[-90.475,19.7666],[-90.482,19.7835],[-90.4643,19.796],[-90.4585,19.8226],[-90.4556,19.8433],[-90.446,19.8818],[-90.4531,19.8993]]]}, style: {color: 'blue', fillColor: '0000FF22'} },
            'Zona 2, Lerma': { geom: {"type":"Polygon","coordinates":[[[-90.592,19.8193],[-90.5996,19.8133],[-90.6083,19.8036],[-90.6327,19.7897],[-90.6385,19.7802],[-90.6396,19.7744],[-90.6351,19.7716],[-90.6279,19.7779],[-90.5997,19.7824],[-90.5924,19.7946],[-90.5741,19.7954],[-90.5831,19.8203],[-90.592,19.8193]]]}, style: {color: 'green', fillColor: '00FF0022'} },
            'Zona 3, Chiná': { geom: {"type":"Polygon","coordinates":[[[-90.5045,19.7762],[-90.5187,19.7562],[-90.5211,19.742],[-90.5021,19.7384],[-90.4856,19.7542],[-90.4626,19.7483],[-90.4602,19.7518],[-90.4748,19.7647],[-90.4813,19.7833],[-90.5046,19.7901],[-90.5045,19.7762]]]}, style: {color: 'orange', fillColor: 'FFA50022'} },
            'Zona 4, San Fco. Campeche': { geom: {"type":"Polygon","coordinates":[[[-90.5051,19.7895],[-90.4811,19.7838],[-90.4643,19.7964],[-90.4464,19.8814],[-90.4541,19.899],[-90.521,19.8621],[-90.5292,19.8663],[-90.5346,19.8625],[-90.5332,19.8567],[-90.5831,19.8203],[-90.5722,19.794],[-90.5495,19.7938],[-90.5261,19.7906],[-90.5051,19.7895]]]}, style: {color: 'purple', fillColor: '80008022'} }
        };
        const varParams = {
            'Temperatura del Aire (°C)': { min: 20, max: 40, palette: ['blue', 'cyan', 'yellow', 'red'], bandName: 'TAM', unit: '°C', dataset: 'ERA5' },
            'Humedad Relativa (%)': { min: 50, max: 100, palette: ['lightyellow', 'green', 'darkblue'], bandName: 'HR', unit: '%', dataset: 'ERA5' },
            'Radiación Solar (W/m²)': { min: 0, max: 1000, palette: ['lightgray', 'orange', 'red'], bandName: 'Radiacion_Solar', unit: 'W/m²', dataset: 'ERA5' },
            'Velocidad del Viento (m/s)': { min: 0, max: 10, palette: ['white', 'lightblue', 'blue'], bandName: 'wind_speed', unit: 'm/s', dataset: 'ERA5' },
            'Temp. Superficial (LST °C)': { min: 20, max: 50, palette: ['navy', 'blue', 'cyan', 'yellow', 'red'], bandName: 'LST', unit: '°C', dataset: 'MODIS' },
            'Precipitación Acumulada (mm)': { min: 0, max: 200, palette: ['#ffffcc', '#a1dab4', '#41b6c4', '#225ea8'], bandName: 'Precipitacion', unit: 'mm', dataset: 'CHIRPS' },
            'Evapotranspiración (mm/8 días)': { min: 0, max: 40, palette: ['#d73027', '#fc8d59', '#fee090', '#e0f3f8', '#91bfdb', '#4575b4'], bandName: 'ET', unit: 'mm/8d', dataset: 'MODIS_ET'},
            'Evapotranspiración Potencial (mm/8 días)': { min: 0, max: 60, palette: ['#d73027', '#fc8d59', '#fee090', '#e0f3f8', '#91bfdb', '#4575b4'], bandName: 'PET', unit: 'mm/8d', dataset: 'MODIS_ET'},
            'Días Grado de Crecimiento (°C día)': { min: 0, max: 20, palette: ['#edf8b1', '#7fcdbb', '#2c7fb8'], bandName: 'GDD', unit: '°C día', dataset: 'ERA5_DAILY'}
        };

        const map = L.map('map').setView([19.83, -90.53], 8);
        L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{ maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] }).addTo(map);
        google.charts.load('current', {'packages':['corechart']});

        let drawnItems = new L.FeatureGroup().addTo(map);
        let currentGeeLayer = null;
        let zoneLayers = {};
        let currentWindLayer = null;

        // =========================================================================================
        // === LÓGICA DE LA INTERFAZ DE USUARIO (UI) =================================================
        // =========================================================================================
        
        // Poblar selectores
        const variableSelector = document.getElementById('variable-selector');
        Object.keys(varParams).forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            variableSelector.appendChild(option);
        });

        const zoneSelectorContainer = document.getElementById('zone-selector');
        Object.keys(zonas).forEach(name => {
            const div = document.createElement('div');
            div.innerHTML = `<input type="checkbox" id="zone-${name.replace(/\s/g, '')}" name="zone" value="${name}" class="mr-2 accent-[var(--accent-color)]">
                             <label for="zone-${name.replace(/\s/g, '')}">${name}</label>`;
            zoneSelectorContainer.appendChild(div);
        });

        // Event Listeners
        document.getElementById('load-data-btn').addEventListener('click', () => loadGeneralData());
        document.getElementById('compare-btn').addEventListener('click', () => loadCompareData());
        document.getElementById('run-precip-analysis').addEventListener('click', () => loadPrecipitationData());
        document.getElementById('run-temp-analysis').addEventListener('click', () => loadTemperatureData());
        document.getElementById('calculate-spi-btn').addEventListener('click', () => loadSpiData());
        document.getElementById('fire-risk-btn').addEventListener('click', () => loadFireRiskData());
        document.getElementById('clear-drawing-btn').addEventListener('click', clearDrawing);
        document.getElementById('reset-app-btn').addEventListener('click', resetApp);
        
        variableSelector.addEventListener('change', (e) => {
            const isPrecip = e.target.value === 'Precipitación Acumulada (mm)';
            const isTemp = e.target.value === 'Temperatura del Aire (°C)';
            document.getElementById('precip-analysis-panel').classList.toggle('hidden', !isPrecip);
            document.getElementById('temp-analysis-panel').classList.toggle('hidden', !isTemp);
        });
        
        zoneSelectorContainer.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                handleZoneSelection(e.target);
            }
        });

        document.getElementById('geojson-upload').addEventListener('change', handleGeoJSONUpload);

        // Lógica de Zonas
        function handleZoneSelection(checkbox) {
            const zoneName = checkbox.value;
            if (checkbox.checked) {
                // Desmarcar otros y limpiar dibujos
                document.querySelectorAll('#zone-selector input[type="checkbox"]').forEach(cb => {
                    if (cb !== checkbox) cb.checked = false;
                });
                clearDrawing(false); // No reiniciar el primer checkbox
                
                Object.values(zoneLayers).forEach(layer => map.removeLayer(layer));
                zoneLayers = {};

                const zona = zonas[zoneName];
                const layer = L.geoJSON(zona.geom, { style: zona.style }).addTo(map);
                zoneLayers[zoneName] = layer;
                map.fitBounds(layer.getBounds());
            } else {
                 if (zoneLayers[zoneName]) {
                    map.removeLayer(zoneLayers[zoneName]);
                    delete zoneLayers[zoneName];
                }
            }
        }
        
        // Lógica de Dibujo
        const drawControl = new L.Control.Draw({
            draw: { polygon: true, rectangle: true, polyline: false, circle: false, marker: false, circlemarker: false },
            edit: { featureGroup: drawnItems }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, function (event) {
            drawnItems.clearLayers();
            const layer = event.layer;
            drawnItems.addLayer(layer);
            // Deseleccionar cualquier zona predefinida
            document.querySelectorAll('#zone-selector input[type="checkbox"]:checked').forEach(cb => {
                cb.checked = false;
                handleZoneSelection(cb);
            });
        });
        
        // =========================================================================================
        // === FUNCIONES PRINCIPALES DE LLAMADA A LA API ===========================================
        // =========================================================================================
        
        async function callGeeApi(action, params, loadingMessage = 'Procesando...') {
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('loading-message').textContent = loadingMessage;
            clearMapLayers();
            updateStats('Cargando...');

            try {
                const response = await fetch('/api/gee', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, params })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.details || `Server responded with ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API Call Error:', error);
                updateStats(`Error: ${error.message}`);
                drawChart(null);
                return null;
            } finally {
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }
        
        async function loadGeneralData() {
            const selectedVar = variableSelector.value;
            if (isSpecialVar(selectedVar)) return;

            const activeRoi = getActiveROI();
            if (!activeRoi) {
                updateStats('Error: Selecciona una zona o dibuja un área.');
                return;
            }

            const params = {
                roi: activeRoi,
                varInfo: varParams[selectedVar],
                startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value
            };

            const data = await callGeeApi('getGeneralData', params, 'Cargando datos generales...');
            if (!data) return;

            addGeeLayer(data.mapId);
            updateStats(data.stats);
            drawChart(data.chartData, data.chartOptions);

            // *** MODIFICACIÓN PARA VIENTO ***
            // Si la respuesta incluye vectores de viento, los dibujamos.
            if (data.windVectors) {
                addWindVectors(data.windVectors);
            }
        }
        
        async function loadCompareData() {
            const selectedRois = getSelectedROIs();
            if (selectedRois.length < 2) {
                updateStats('Error: Selecciona al menos 2 zonas o dibuja 2+ polígonos para comparar.');
                return;
            }
            
            const selectedVar = variableSelector.value;
            const params = {
                rois: selectedRois,
                varInfo: varParams[selectedVar],
                startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value,
            };

            const data = await callGeeApi('getCompareData', params, 'Comparando zonas...');
            if (!data) return;

            updateStats(data.stats);
            drawChart(data.chartData, data.chartOptions);
        }

        async function loadPrecipitationData() {
            const activeRoi = getActiveROI();
            if (!activeRoi) return;
            
            const params = {
                roi: activeRoi,
                analysisType: document.getElementById('precip-analysis-selector').value,
                aggregation: document.getElementById('precip-aggregation-selector').value,
                startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value,
            };
            
            const data = await callGeeApi('getPrecipitationData', params, 'Analizando precipitación...');
            if (!data) return;

            addGeeLayer(data.mapId);
            updateStats(data.stats);
            drawChart(data.chartData, data.chartOptions);
        }
        
        async function loadTemperatureData() {
            const activeRoi = getActiveROI();
            if (!activeRoi) return;
            
            const params = {
                roi: activeRoi,
                analysisType: document.getElementById('temp-analysis-selector').value,
                startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value,
            };
            
            const data = await callGeeApi('getTemperatureData', params, 'Analizando temperatura...');
            if (!data) return;

            addGeeLayer(data.mapId);
            updateStats(data.stats);
            drawChart(null); // No chart for this analysis
        }
        
        async function loadSpiData() {
             const activeRoi = getActiveROI();
            if (!activeRoi) return;
            
            const params = {
                roi: activeRoi,
                timescale: parseInt(document.getElementById('spi-timescale-selector').value),
                startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value,
            };
            
            const data = await callGeeApi('getSpiData', params, 'Calculando SPI...');
            if (!data) return;

            addGeeLayer(data.mapId);
            updateStats(data.stats);
            drawChart(data.chartData, data.chartOptions);
        }
        
        async function loadFireRiskData() {
            const activeRoi = getActiveROI();
            if (!activeRoi) return;
            
            const params = {
                roi: activeRoi,
                endDate: document.getElementById('end-date').value,
            };
            
            const data = await callGeeApi('getFireRiskData', params, 'Generando mapa de riesgo de incendio...');
            if (!data) return;

            addGeeLayer(data.mapId);
            updateStats(data.stats);
            drawChart(null);
        }

        // =========================================================================================
        // === FUNCIONES AUXILIARES Y DE MANEJO DEL MAPA ===========================================
        // =========================================================================================

        function getActiveROI() {
            if (drawnItems.getLayers().length > 0) {
                return { geom: drawnItems.getLayers()[0].toGeoJSON().geometry, name: 'Área Dibujada' };
            }
            const checkedZone = document.querySelector('#zone-selector input[type="checkbox"]:checked');
            if (checkedZone) {
                const zoneName = checkedZone.value;
                return { geom: zonas[zoneName].geom, name: zoneName };
            }
            return null;
        }
        
        function getSelectedROIs() {
            let selected = [];
            if (drawnItems.getLayers().length > 0) {
                 drawnItems.getLayers().forEach((layer, i) => {
                     selected.push({ geom: layer.toGeoJSON().geometry, name: `Área Dibujada ${i + 1}` });
                 });
            } else {
                 document.querySelectorAll('#zone-selector input[type="checkbox"]:checked').forEach(cb => {
                    const zoneName = cb.value;
                    selected.push({ geom: zonas[zoneName].geom, name: zoneName });
                 });
            }
            return selected;
        }

        function clearMapLayers() {
            if (currentGeeLayer) map.removeLayer(currentGeeLayer);
            if (currentWindLayer) map.removeLayer(currentWindLayer);
            currentGeeLayer = null;
            currentWindLayer = null;
        }

        function addGeeLayer(mapId) {
            if (!mapId) return;
            const url = `https://earthengine.googleapis.com/v1alpha/${mapId.mapid}/tiles/{z}/{x}/{y}`;
            currentGeeLayer = L.tileLayer(url, { attribution: 'Google Earth Engine' }).addTo(map);
        }
        
        // *** NUEVA FUNCIÓN PARA AÑADIR VECTORES DE VIENTO ***
        function addWindVectors(vectors) {
            if (!vectors || !vectors.features) return;
            
            currentWindLayer = L.geoJSON(vectors, {
                pointToLayer: function (feature, latlng) {
                    const props = feature.properties;
                    const rotation = props.rotation || 0;
                    const magnitude = props.magnitude || 0;
                    
                    // Escalar el tamaño del ícono basado en la magnitud
                    const iconSize = Math.min(Math.max(magnitude * 5, 15), 50);

                    // Crear un ícono SVG de flecha
                    const arrowSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${iconSize}" height="${iconSize}" fill="white" style="transform: rotate(${rotation}deg);">
                        <path d="M12 2L12 18M12 2L6 8M12 2L18 8" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>`;

                    const customIcon = L.divIcon({
                        html: arrowSvg,
                        className: '', // Sin clase para evitar estilos por defecto
                        iconSize: [iconSize, iconSize],
                        iconAnchor: [iconSize / 2, iconSize / 2]
                    });

                    return L.marker(latlng, { icon: customIcon });
                }
            }).addTo(map);
        }

        function updateStats(message) {
            document.getElementById('stats-summary').textContent = message;
        }

        function drawChart(data, options) {
            const chartContainer = document.getElementById('chart-container');
            chartContainer.innerHTML = '';
            if (!data || data.length < 2) { // 1 Fila de encabezado + 0 filas de datos
                chartContainer.innerHTML = '<p class="text-center text-gray-400 mt-8">No hay datos para mostrar en el gráfico.</p>';
                return;
            }

            const chartType = document.getElementById('chart-type-selector').value;
            const dataTable = google.visualization.arrayToDataTable(data);
            const chartOptions = {
                title: options.title || 'Serie Temporal',
                backgroundColor: '#111827', // bg-gray-900
                colors: ['#38bdf8', '#fbbf24', '#34d399', '#f87171', '#a78bfa'],
                titleTextStyle: { color: '#FFFFFF' },
                vAxis: { textStyle: { color: '#d1d5db' }, titleTextStyle: { color: '#d1d5db' }, gridlines: { color: '#374151'} },
                hAxis: { textStyle: { color: '#d1d5db' }, titleTextStyle: { color: '#d1d5db' }, gridlines: { color: '#374151'} },
                legend: { textStyle: { color: '#FFFFFF' }, position: 'top' },
                chartArea: {'width': '85%', 'height': '70%'},
            };
            const chart = new google.visualization[chartType](chartContainer);
            chart.draw(dataTable, chartOptions);
        }
        
        function handleGeoJSONUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const geojson = JSON.parse(e.target.result);
                    drawnItems.clearLayers();
                    const geoJsonLayer = L.geoJSON(geojson);
                    drawnItems.addLayer(geoJsonLayer);
                    map.fitBounds(geoJsonLayer.getBounds());
                    // Deseleccionar cualquier zona predefinida
                     document.querySelectorAll('#zone-selector input[type="checkbox"]:checked').forEach(cb => {
                        cb.checked = false;
                        handleZoneSelection(cb);
                    });
                } catch (error) {
                    updateStats('Error: Archivo GeoJSON inválido.');
                }
            };
            reader.readAsText(file);
        }

        function clearDrawing(resetFirst = true) {
            drawnItems.clearLayers();
            if (resetFirst) {
                document.querySelectorAll('#zone-selector input[type="checkbox"]').forEach((cb, index) => {
                    cb.checked = index === 0;
                    handleZoneSelection(cb);
                });
            }
        }

        function resetApp() {
            clearMapLayers();
            clearDrawing();
            updateStats('Selecciona opciones y carga datos para ver un resumen.');
            drawChart(null);
            document.getElementById('start-date').value = '2023-01-01';
            document.getElementById('end-date').value = '2023-12-31';
            variableSelector.selectedIndex = 0;
            variableSelector.dispatchEvent(new Event('change'));
            map.setView([19.83, -90.53], 8);
        }

        function isSpecialVar(varName) {
            if (varName === 'Precipitación Acumulada (mm)' || varName === 'Temperatura del Aire (°C)') {
                updateStats(`Para esta variable, por favor usa el panel de análisis específico correspondiente.`);
                return true;
            }
            return false;
        }

        // Inicialización
        document.querySelector('#zone-selector input[type="checkbox"]').checked = true;
        handleZoneSelection(document.querySelector('#zone-selector input[type="checkbox"]'));
    </script>
</body>
</html>

